<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Avaliação automática - Trabalho 2</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>

  <style>
    html, body, #viewDiv { height: 100%; width: 100%; margin: 0; padding: 0; }
    .panel {
      position: absolute; z-index: 10; top: 12px; left: 12px;
      background: white; padding: 10px 12px; border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,.15); width: 360px;
      font-family: Arial, sans-serif; font-size: 13px;
      max-height: calc(100vh - 24px);
      overflow: auto;
    }
    .ok { color: #0a7; font-weight: 700; }
    .no { color: #c33; font-weight: 700; }
    .muted { color: #666; }
    button { cursor: pointer; }
    hr { border: none; border-top: 1px solid #eee; margin: 10px 0; }
    .small { font-size: 12px; }
  </style>
</head>

<body>
  <div class="panel">
    <div><b>Avaliação automática</b></div>
    <div class="muted" style="margin-top:6px">
      1) Desenhe a área no mapa.<br/>
      2) Clique em <b>Avaliar</b>.
    </div>

    <div style="margin-top:8px; display:flex; gap:8px;">
      <button id="btn">Avaliar</button>
      <button id="btnClear">Limpar</button>
    </div>

    <div id="out" style="margin-top:10px"></div>
  </div>

  <div id="viewDiv"></div>

<script>
require([
  "esri/WebMap",
  "esri/views/MapView",
  "esri/widgets/Sketch",
  "esri/layers/GraphicsLayer",
  "esri/geometry/support/webMercatorUtils"
], function(WebMap, MapView, Sketch, GraphicsLayer, webMercatorUtils) {

  const WEBMAP_ID = "5f392c9832394c86b1cfca35f215d47e";
  const WFS_BASE  = "https://geoserver.meioambiente.mg.gov.br/ows";

  const webmap = new WebMap({
    portalItem: { id: WEBMAP_ID }
  });

  const view = new MapView({
    container: "viewDiv",
    map: webmap
  });

  const drawLayer = new GraphicsLayer({ title: "Área do usuário" });
  webmap.add(drawLayer);

  const sketch = new Sketch({
    layer: drawLayer,
    view,
    creationMode: "single",
    availableCreateTools: ["polygon", "rectangle"]
  });
  view.ui.add(sketch, "top-right");

  document.getElementById("btnClear").onclick = () => {
    drawLayer.removeAll();
    document.getElementById("out").innerHTML = "";
  };

  function polygonToWKT4326(geom) {
    let g = geom;
    if (g.spatialReference && g.spatialReference.isWebMercator) {
      g = webMercatorUtils.webMercatorToGeographic(g);
    }
    const ring = g.rings[0];
    const coords = ring.map(pt => `${pt[0]} ${pt[1]}`);
    if (coords[0] !== coords[coords.length - 1]) coords.push(coords[0]);
    return `POLYGON((${coords.join(",")}))`;
  }

  async function wfsHits(typeName, geomField, wkt) {
    const geomCandidates = [geomField, "geom", "the_geom"]
      .filter((v, i, a) => v && a.indexOf(v) === i);

    async function tryRequest({ version, typeParam }, gf) {
      const url = new URL(WFS_BASE);
      url.searchParams.set("service", "WFS");
      url.searchParams.set("version", version);
      url.searchParams.set("request", "GetFeature");
      url.searchParams.set(typeParam, typeName);
      url.searchParams.set("resultType", "hits");
      url.searchParams.set("outputFormat", "application/json");
      url.searchParams.set("CQL_FILTER", `INTERSECTS(${gf}, ${wkt})`);
      url.searchParams.set("srsName", "EPSG:4326");

      const r = await fetch(url.toString());
      if (!r.ok) throw new Error(`WFS ${r.status} em ${typeName}`);
      const j = await r.json();
      return (typeof j.numberMatched === "number") ? j.numberMatched : 0;
    }

    const attempts = [
      { version: "2.0.0", typeParam: "typeNames" },
      { version: "1.1.0", typeParam: "typeName" }
    ];

    let lastErr = null;
    for (const gf of geomCandidates) {
      for (const a of attempts) {
        try {
          return await tryRequest(a, gf);
        } catch (e) {
          lastErr = e;
        }
      }
    }

    throw lastErr || new Error("Falha WFS");
  }

  document.getElementById("btn").onclick = async () => {
    const out = document.getElementById("out");
    out.innerHTML = "Avaliando...";

    const g = drawLayer.graphics.getItemAt(0);
    if (!g) {
      out.innerHTML = "Desenhe uma área primeiro.";
      return;
    }

    const wkt = polygonToWKT4326(g.geometry);

    const layers = webmap.layers.items;

    let html = "";

    for (const layer of layers) {
      if (!layer.title) continue;

      try {
        const hits = await wfsHits(layer.title, "geom", wkt);
        const ok = hits > 0;

        layer.visible = ok;

        html += `${layer.title}: ${ok ? "SIM" : "NÃO"} (feições: ${hits})<br/>`;
      } catch (e) {
        html += `${layer.title}: erro (${e.message})<br/>`;
      }
    }

    out.innerHTML = html;
  };

});
</script>
</body>
</html>
